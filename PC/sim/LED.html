<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebSerial Minimal - Connect/Disconnect/Receive</title>
  <style>
    html, body { margin:0; height:100%; background:#0b0f14; color:#e8eef7; font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
    #ui { padding: 14px; display:flex; gap:10px; align-items:center; }
    button {
      padding: 10px 14px; border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06); color:#e8eef7; cursor:pointer;
    }
    button:disabled { opacity:.45; cursor:not-allowed; }
    #status { opacity:.9; font-size: 13px; }
    #log {
      width: calc(100% - 28px);
      height: calc(100% - 70px);
      margin: 0 14px 14px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      padding: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      line-height: 1.4;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="connect">Connect</button>
    <button id="disconnect" disabled>Disconnect</button>
    <span id="status">serial: OFF</span>
  </div>
  <div id="log"></div>

  <script>
    let port = null;

    // readableから読む用
    let reader = null;
    let textDecoder = null;

    // 受信バッファ（行単位で整形したい時に使う）
    let rxBuf = "";

    const $connect = document.getElementById("connect");
    const $disconnect = document.getElementById("disconnect");
    const $status = document.getElementById("status");
    const $log = document.getElementById("log");

    function setStatus(on){
      $connect.disabled = on;
      $disconnect.disabled = !on;
      $status.textContent = on ? "serial: ON" : "serial: OFF";
    }

    function logLine(s){
      $log.textContent += s + "\n";
      $log.scrollTop = $log.scrollHeight;
    }

    async function connect(){
      if (!("serial" in navigator)) {
        alert("WebSerial非対応です。Chromeで開いてください。");
        return;
      }
      if (port) return;

      // ユーザー操作内で必須
      port = await navigator.serial.requestPort();
      await port.open({ baudRate: 115200 });

      setStatus(true);
      logLine("[connected]");

      // 受信開始：TextDecoderStream で bytes -> text
      textDecoder = new TextDecoderStream();
      const readableClosed = port.readable.pipeTo(textDecoder.writable);

      reader = textDecoder.readable.getReader();

      // 読みループ（切断されるまで回る）
      (async () => {
        try {
          while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            if (value) onText(value);
          }
        } catch (e) {
          logLine("[read error] " + e.message);
        } finally {
          try { reader?.releaseLock(); } catch {}
          reader = null;
        }
      })();

      // ここで readableClosed を await しない（ログ用途なので）
      readableClosed.catch(() => {});
    }

    function onText(txt){
      // MicroPythonのprintはだいたい \r\n なので行単位に整形
      rxBuf += txt;
      const lines = rxBuf.split(/\r?\n/);
      rxBuf = lines.pop(); // 最後の未確定行は次回へ
      for (const line of lines) {
        if (line.length) logLine(line);
      }
    }

    async function disconnect(){
      if (!port) return;

      logLine("[disconnecting]");

      try { await reader?.cancel(); } catch {}
      try { reader?.releaseLock(); } catch {}
      reader = null;

      try { await port.close(); } catch {}
      port = null;
      textDecoder = null;

      setStatus(false);
      logLine("[disconnected]");
    }

    // UI
    $connect.onclick = async () => {
      try { await connect(); }
      catch (e) { logLine("[connect failed] " + e.message); await disconnect(); }
    };
    $disconnect.onclick = async () => { await disconnect(); };

    // ページ離脱時にクローズ
    window.addEventListener("beforeunload", () => {
      // beforeunloadでawaitは効きにくいのでベストエフォート
      if (port) { try { port.close(); } catch {} }
    });

    setStatus(false);
  </script>
</body>
</html>
